name: build-noble

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build
        run: |
          cd scripts
          sed -i -E -e 's/^TARGET_UBUNTU_VERSION=.*/TARGET_UBUNTU_VERSION="noble"/' -e 's/^TARGET_ROS_VERSION=.*/TARGET_ROS_VERSION="jazzy"/' config.sh
          ./build.sh -
          cd ..
      - name: Archive artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-from-scratch
          path: |
            scripts/ubuntu-from-scratch.iso
            scripts/image/md5sum.txt

      - name: Cleanup chroot mounts (always)
        if: always()
        shell: bash
        run: |
          set -x
          CHROOT="$GITHUB_WORKSPACE/scripts/chroot"

          sudo mount | grep "$CHROOT" || true
          command -v fuser >/dev/null && sudo fuser -vm "$CHROOT" || true

          if [ -d "$CHROOT" ] ; then
            sudo chroot "$CHROOT" /bin/bash -c 'killall -q -w -s TERM -u root || true' || true
          fi

          for m in dev/pts dev proc sys run ; do
            if mountpoint -q "$CHROOT/$m" ; then
              sudo umount -l "$CHROOT/$m" || true
            fi
          done

          if mountpoint -q "$CHROOT" ; then
            sudo umount -R -l "$CHROOT" || true
          fi
